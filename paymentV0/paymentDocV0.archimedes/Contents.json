{
  "sections" : [
    {
      "type" : "plain",
      "contents" : "å†™ä¸€ä¸ª Python å®ç°çš„æœ€å°æ”¯ä»˜ç³»ç»Ÿæ ·ä¾‹ï¼ˆå« webhook + idempotency å¤„ç†ï¼‰\n\n\nä¸‹é¢æ˜¯ä¸€ä¸ªPython æœ€å°æ”¯ä»˜ç³»ç»Ÿæ ·ä¾‹ï¼Œç”¨ Flask æ¨¡æ‹Ÿä¸€ä¸ªå…¸å‹æ”¯ä»˜æµç¨‹ï¼ŒåŒ…æ‹¬ï¼š\n\nåˆ›å»ºè®¢å•å¹¶å‘èµ·æ”¯ä»˜\n\næ¨¡æ‹Ÿæ”¯ä»˜ç½‘å…³å›è°ƒï¼ˆWebhookï¼‰\n\nå®ç°å¹‚ç­‰å¤„ç†ï¼ˆé˜²æ­¢é‡å¤æ‰£æ¬¾ï¼‰\n\nğŸ›  ç¯å¢ƒè¦æ±‚\nPython 3.8+\n\nFlask\n\nRedisï¼ˆç”¨äºå¹‚ç­‰æ€§æ£€æŸ¥ï¼‰\n\nä½ å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…ä¾èµ–ï¼š\n\nbash\nCopy\nEdit\npip install flask redis\nğŸ“¦ ç›®å½•ç»“æ„\nbash\nCopy\nEdit\npayment_demo\/\nâ”œâ”€â”€ app.py               # ä¸»ç¨‹åº\nâ”œâ”€â”€ redis_client.py      # Redis å®¢æˆ·ç«¯å·¥å…·\nâ””â”€â”€ simulate_gateway.py  # æ¨¡æ‹Ÿæ”¯ä»˜å¹³å°å›è°ƒ\n\n\n1ï¸âƒ£ redis_client.py\npython\nCopy\nEdit\nimport redis\n\n# æœ¬åœ° Redis é»˜è®¤é…ç½®\nr = redis.Redis(host=\"localhost\", port=6379, db=0, decode_responses=True)\n\ndef set_idempotency_key(key: str, value: str, ttl: int = 600):\n    if not r.exists(key):\n        r.set(key, value, ex=ttl)\n        return True\n    return False\n\ndef get_value(key: str):\n    return r.get(key)\n\n\n2ï¸âƒ£ app.pyï¼ˆä¸»æœåŠ¡ï¼‰\npython\nCopy\nEdit\nfrom flask import Flask, request, jsonify\nfrom redis_client import set_idempotency_key, get_value\nimport uuid\n\napp = Flask(__name__)\n\n# æ¨¡æ‹Ÿæ•°æ®åº“ï¼ˆå†…å­˜ï¼‰\nORDERS = {}\nPAYMENTS = {}\n\n@app.route(\"\/create_order\", methods=[\"POST\"])\ndef create_order():\n    user_id = request.json[\"user_id\"]\n    amount = request.json[\"amount\"]\n    order_id = str(uuid.uuid4())\n    \n    ORDERS[order_id] = {\n        \"user_id\": user_id,\n        \"amount\": amount,\n        \"status\": \"PENDING\"\n    }\n\n    return jsonify({\"order_id\": order_id})\n\n@app.route(\"\/initiate_payment\", methods=[\"POST\"])\ndef initiate_payment():\n    order_id = request.json[\"order_id\"]\n    payment_id = str(uuid.uuid4())\n    idempotency_key = f\"payment:{payment_id}\"\n\n    if not set_idempotency_key(idempotency_key, \"initiated\"):\n        return jsonify({\"error\": \"Duplicate payment\"}), 409\n\n    PAYMENTS[payment_id] = {\n        \"order_id\": order_id,\n        \"status\": \"PENDING\"\n    }\n\n    # å‡è®¾æ”¯ä»˜é“¾æ¥ä¸ºæ¨¡æ‹Ÿè·³è½¬\n    return jsonify({\n        \"payment_id\": payment_id,\n        \"payment_url\": f\"http:\/\/localhost:5000\/simulate_gateway_callback\/{payment_id}\"\n    })\n\n@app.route(\"\/webhook\/payment_callback\", methods=[\"POST\"])\ndef payment_callback():\n    payment_id = request.json[\"payment_id\"]\n    success = request.json[\"success\"]\n    idempotency_key = f\"callback:{payment_id}\"\n\n    if not set_idempotency_key(idempotency_key, \"received\"):\n        return jsonify({\"message\": \"Duplicate callback\"}), 200\n\n    payment = PAYMENTS.get(payment_id)\n    if not payment:\n        return jsonify({\"error\": \"Invalid payment ID\"}), 404\n\n    if success:\n        payment[\"status\"] = \"PAID\"\n        order_id = payment[\"order_id\"]\n        ORDERS[order_id][\"status\"] = \"PAID\"\n    else:\n        payment[\"status\"] = \"FAILED\"\n\n    return jsonify({\"message\": \"Callback processed\"})\n\n@app.route(\"\/orders\", methods=[\"GET\"])\ndef get_orders():\n    return jsonify(ORDERS)\n\nif __name__ == \"__main__\":\n    app.run(debug=True)\n\n\n3ï¸âƒ£ simulate_gateway.pyï¼ˆæ¨¡æ‹Ÿæ”¯ä»˜å¹³å°å›è°ƒï¼‰\npython\nCopy\nEdit\nimport requests\nimport sys\n\npayment_id = sys.argv[1] if len(sys.argv) > 1 else None\nif not payment_id:\n    print(\"Usage: python simulate_gateway.py <payment_id>\")\n    exit()\n\nres = requests.post(\"http:\/\/localhost:5000\/webhook\/payment_callback\", json={\n    \"payment_id\": payment_id,\n    \"success\": True\n})\n\nprint(\"Webhook sent:\", res.status_code, res.json())\n\n\nğŸ” æµç¨‹æ¼”ç¤ºï¼ˆæœ¬åœ°ç«¯å£ä¸º 5000ï¼‰\nå¯åŠ¨ Redis\n\nå¯åŠ¨ Flask æœåŠ¡ï¼š\n\nbash\nCopy\nEdit\npython app.py\nåˆ›å»ºè®¢å•ï¼š\n\nbash\nCopy\nEdit\ncurl -X POST http:\/\/localhost:5000\/create_order -H \"Content-Type: application\/json\" -d '{\"user_id\": \"u001\", \"amount\": 100}'\nå‘èµ·æ”¯ä»˜ï¼š\n\nbash\nCopy\nEdit\ncurl -X POST http:\/\/localhost:5000\/initiate_payment -H \"Content-Type: application\/json\" -d '{\"order_id\": \"<ä¸Šä¸€æ­¥è¿”å›çš„order_id>\"}'\nç”¨è¿”å›çš„ payment_id è§¦å‘ webhook æ¨¡æ‹Ÿï¼š\n\nbash\nCopy\nEdit\npython simulate_gateway.py <payment_id>\næŸ¥çœ‹è®¢å•çŠ¶æ€ï¼š\n\nbash\nCopy\nEdit\ncurl http:\/\/localhost:5000\/orders\n\n\nâœ… å¹‚ç­‰æ€§ä¿è¯ç‚¹\nåœºæ™¯\tKey\tåŠŸèƒ½\nå‘èµ·æ”¯ä»˜\tpayment:{payment_id}\té¿å…é‡å¤æäº¤æ”¯ä»˜\næ”¯ä»˜å›è°ƒ\tcallback:{payment_id}\té¿å…é‡å¤å¤„ç†å›è°ƒï¼ˆå¦‚å¤šæ¬¡å›è°ƒï¼‰\n\nğŸ§  ä¸‹ä¸€æ­¥ä½ å¯ä»¥æ‰©å±•ï¼š\nä½¿ç”¨çœŸå®æ•°æ®åº“ï¼ˆPostgreSQL, MySQLï¼‰\n\nåŠ å…¥ MQ æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥çŠ¶æ€æµè½¬\n\nå¢åŠ è¶…æ—¶å…³é—­ã€é€€æ¬¾ç­‰çŠ¶æ€\n\nå¢åŠ è®¢å•çŠ¶æ€æœºæ§åˆ¶\n\nå¦‚ä½ æƒ³ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ æ¥å…¥ Stripe \/ å¾®ä¿¡æ”¯ä»˜ çœŸå®ç½‘å…³æ¥å£ç‰ˆæœ¬ã€‚æ˜¯å¦éœ€è¦ç»§ç»­å‡çº§ï¼Ÿ\n\n\n\n"
    }
  ],
  "metadata" : {
    "leftMargin" : 2.54,
    "bottomMargin" : 2.54,
    "pageSize" : 0,
    "rightMargin" : 2.54,
    "indentStyle" : "tabs",
    "pageNumberingEnabled" : false,
    "indentWidth" : 4,
    "writingDirection" : -1,
    "topMargin" : 2.54,
    "previewStyle" : "preview_modern"
  }
}